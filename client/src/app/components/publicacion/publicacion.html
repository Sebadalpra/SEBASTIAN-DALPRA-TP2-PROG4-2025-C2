<div class="card shadow-sm mb-3">
	<div class="card-body">

		<div class="d-flex align-items-center mb-3">
			<!-- foto de perfil -->
			@if(fotoPerfilUrl) {
			<img [src]="fotoPerfilUrl" 
				class="img-fluid rounded-circle border border-2 border-primary shadow" 
				alt="Foto de perfil"
				style="width: 50px; height: 50px; object-fit: cover;" />
			}
			@else {
				<!-- avatar con primera letra del Usernme -->
			<div 
				class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center border border-2 border-primary shadow" 
				style="width: 50px; height: 50px; font-size: 1.5rem;">
				<span>{{ publicacion.username | capitalizePipe | inicialesPipe:'' }}</span>
			</div>
			}
			<div class="ms-3 flex-grow-1" >
				<h6 class="mb-0">{{ publicacion.username }}</h6>
				<small class="text-muted">{{ publicacion.fecha_creacion | fechaLargaPipe }}</small>
			</div>

			<div class="d-flex gap-2">
				@if (esDuenioPublicacion()) {
					<button class="btn btn-danger btn-sm" (click)="eliminarPublicacion()">
						<i class="bi bi-trash"></i> Eliminar
					</button>
				}

				@if (esAdmin()) {
					<button class="btn btn-warning btn-sm" (click)="darDeBajaPublicacion()">
						<i class="bi bi-ban"></i> Dar de baja
					</button>
				}
			</div>

		</div>
		<h5 class="card-title fw-bold">{{ publicacion.titulo }}</h5>
		<p class="card-text">{{ publicacion.mensaje }}</p>
		<!-- imagen del body -->
			@if (publicacion.imagen) {
				<div class="text-center mb-3">
					<img [src]="buildRutaImagen(publicacion.imagen)" class="img-fluid rounded shadow-sm border border-2" style="max-height: 500px; object-fit: cover;" alt="Imagen de la publicación" />
				</div>
			}
		<hr class="my-3">

		<div class="d-flex gap-2 mb-2">

			<button class="btn btn-outline-danger btn-sm" (click)="darLike()" [disabled]="cargandoLike">
				<i class="bi bi-heart me-1"></i>Me gusta ({{ publicacion.likes?.length || 0 }})
			</button>

			<button class="btn btn-outline-secondary btn-sm" (click)="quitarLike()" [disabled]="cargandoLike">
				<i class="bi bi-x-circle me-1"></i>Quitar Like
			</button>

		</div>

		<div class="comentarios mt-3">
			<h6 class="fw-bold">Comentarios ({{ publicacion.comentarios?.length || 0 }})</h6>
			
			@for (comentario of comentariosVisibles(); track comentario._id) {
				<div class="container-comentario">
					<!-- Modo lectura -->
					@if (comentarioEditando !== comentario._id) {
						<div class="d-flex justify-content-between align-items-start">
							<div>
								<!-- simplemente mostrarlo -->
								<span class="fw-semibold">{{ comentario.username }}:</span> {{ comentario.texto }}

								@if (comentario.modificado) {
									<span class="modificado">(Modificado)</span>
								}
							</div>

							<!-- btn para editar a los usuarios dueños de sus comentarios -->
							@if (esDuenioComentario(comentario)) {
								<button class="btn btn-sm btn-outline-primary" (click)="editarComentario(comentario)">
									<i class="bi bi-pencil"></i>
								</button>
							}
						</div>
					}
					
					<!-- Modo edición -->
					@if (comentarioEditando === comentario._id) {
						<div>
							<input [(ngModel)]="textoEditado" class="form-control form-control-sm mb-2" />
							<div class="d-flex gap-2">

								<button class="btn btn-sm btn-success" (click)="guardarEdicion(comentario._id)">
									<i class="bi bi-check"></i> Guardar
								</button>

								<button class="btn btn-sm btn-secondary" (click)="cancelarEdicion()">
									<i class="bi bi-x"></i> Cancelar
								</button>
								
							</div>
						</div>
					}
				</div>
			}

			<!-- Botones de paginación -->
			@if (hayMasComentarios()) {
				<button class="btn btn-sm btn-link" (click)="verMasComentarios()">
					Ver más comentarios...
				</button>
			}
			@if (mostrarTodos && publicacion.comentarios?.length > limite) {
				<button class="btn btn-sm btn-link" (click)="verMenosComentarios()">
					Ver menos
				</button>
			}

			<div class="input-group mt-2">
				<input [(ngModel)]="nuevoComentario" class="form-control form-control-sm" placeholder="Escribe un comentario..." />
				<button class="btn btn-primary btn-sm" (click)="comentar()" [disabled]="cargandoComentario">Comentar</button>
			</div>
		</div>
	</div>
</div>
